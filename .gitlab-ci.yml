# GitLab CI/CD Pipeline for CM3 Batch Automations

stages:
  - lint
  - test
  - build
  - deploy

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHONPATH: "$CI_PROJECT_DIR"

# Cache pip packages
cache:
  paths:
    - .cache/pip
    - venv/

# Default before_script
.before_script_template: &before_script_definition
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install -r requirements.txt

# Lint stage
lint:flake8:
  stage: lint
  image: python:3.9
  <<: *before_script_definition
  script:
    - echo "Running flake8 linting..."
    - flake8 src/ tests/ --count --statistics
  allow_failure: false

lint:black:
  stage: lint
  image: python:3.9
  <<: *before_script_definition
  script:
    - echo "Checking code formatting with black..."
    - black --check src/ tests/
  allow_failure: true  # Warning only for now

# Test stage
test:unit:
  stage: test
  image: python:3.9
  <<: *before_script_definition
  script:
    - echo "Running unit tests..."
    - pytest tests/unit -v --cov=src --cov-report=xml --cov-report=term-missing --cov-fail-under=80
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 1 week
  allow_failure: false

test:integration:
  stage: test
  image: python:3.9
  <<: *before_script_definition
  script:
    - echo "Running integration tests..."
    - pytest tests/integration -v
  allow_failure: true  # Integration tests may require DB
  only:
    - main
    - merge_requests

# Build stage
build:pex:
  stage: build
  image: python:3.9
  <<: *before_script_definition
  script:
    - echo "Building PEX executable..."
    - pip install pex
    - chmod +x build_pex.sh
    - ./build_pex.sh
  artifacts:
    paths:
      - dist/cm3-batch.pex
    expire_in: 30 days
  only:
    - main
    - tags

build:rpm:
  stage: build
  image: registry.access.redhat.com/ubi8/python-39
  before_script:
    - yum install -y rpm-build rpmdevtools
    - rpmdev-setuptree
  script:
    - echo "Building RPM package..."
    - chmod +x build_rpm.sh
    - ./build_rpm.sh
  artifacts:
    paths:
      - ~/rpmbuild/RPMS/noarch/*.rpm
    expire_in: 30 days
  only:
    - main
    - tags
  allow_failure: true  # RPM build may fail in CI environment

# Deploy stage (placeholder)
deploy:staging:
  stage: deploy
  image: python:3.9
  script:
    - echo "Deploying to staging environment..."
    - echo "Add deployment commands here"
  only:
    - main
  when: manual
  environment:
    name: staging
    url: https://staging.example.com

deploy:production:
  stage: deploy
  image: python:3.9
  script:
    - echo "Deploying to production environment..."
    - echo "Add deployment commands here"
  only:
    - tags
  when: manual
  environment:
    name: production
    url: https://production.example.com
