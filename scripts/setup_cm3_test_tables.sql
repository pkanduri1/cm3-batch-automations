-- CM3 on-prem test schema setup (idempotent)
-- Run as SYSTEM (or a user with privileges to create objects in CM3INT/CM3AUDIT)
-- Example:
--   sqlplus system/<password>@localhost:1521/FREEPDB1 @scripts/setup_cm3_test_tables.sql

WHENEVER SQLERROR EXIT SQL.SQLCODE

BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE CM3INT."TRANSACTION" CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN
  IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE CM3INT.CUSTOMER CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN
  IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE CM3AUDIT.CM3_LOAD_AUDIT CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN
  IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

PROMPT Creating CUSTOMER table in CM3INT...
CREATE TABLE CM3INT.CUSTOMER (
  CUSTOMER_ID      VARCHAR2(20) PRIMARY KEY,
  FIRST_NAME       VARCHAR2(50)  NOT NULL,
  LAST_NAME        VARCHAR2(50)  NOT NULL,
  EMAIL            VARCHAR2(100),
  PHONE_NUMBER     VARCHAR2(20),
  ACCOUNT_BALANCE  NUMBER(12,2)  DEFAULT 0 NOT NULL,
  STATUS           VARCHAR2(20)  NOT NULL,
  CREATED_TS       TIMESTAMP     DEFAULT CURRENT_TIMESTAMP
);

PROMPT Creating TRANSACTION table in CM3INT...
CREATE TABLE CM3INT."TRANSACTION" (
  TRANSACTION_ID    VARCHAR2(20) PRIMARY KEY,
  CUSTOMER_ID       VARCHAR2(20) NOT NULL,
  TRANSACTION_DATE  DATE         NOT NULL,
  AMOUNT            NUMBER(12,2) NOT NULL,
  TRANSACTION_TYPE  VARCHAR2(20) NOT NULL,
  DESCRIPTION       VARCHAR2(200),
  CREATED_TS        TIMESTAMP    DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT FK_TRX_CUSTOMER FOREIGN KEY (CUSTOMER_ID)
    REFERENCES CM3INT.CUSTOMER (CUSTOMER_ID)
);

PROMPT Creating CM3 load audit table in CM3AUDIT...
CREATE TABLE CM3AUDIT.CM3_LOAD_AUDIT (
  AUDIT_ID         NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  LOAD_TS          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  PIPELINE_NAME    VARCHAR2(100) NOT NULL,
  STATUS           VARCHAR2(20)  NOT NULL,
  RECORD_COUNT     NUMBER,
  DETAILS          VARCHAR2(400)
);

COMMIT;
PROMPT Done.
